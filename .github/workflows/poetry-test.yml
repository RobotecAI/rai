name: Poetry install and test in docker

on:
  pull_request:
    branches:
      - development

jobs:
  test-with-ros2-humble:
    runs-on: self-hosted
    name: Test with ROS2 Humble on Ubuntu 22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Build Docker Image for ROS2 Humble
        run: docker build -f docker/Dockerfile.humble -t ros2_humble_poetry .

      - name: Run Tests in ROS2 Humble Container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace ros2_humble_poetry \
          bash -c "source /opt/ros/humble/setup.bash && poetry install && poetry run pytest"

  test-with-ros2-jazzy:
    runs-on: self-hosted
    name: Test with ROS2 Jazzy on Ubuntu 24.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Build Docker Image for ROS2 Jazzy
        run: docker build -f docker/Dockerfile.jazzy -t ros2_jazzy_poetry .

      - name: Run Tests in ROS2 Jazzy Container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace ros2_jazzy_poetry \
          bash -c "source /opt/ros/jazzy/setup.bash && poetry install && poetry run pytest"
