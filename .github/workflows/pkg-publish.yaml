name: Publish package to PyPI / Test PyPI

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package(s) to publish. Single package: 'rai_core'. Multiple packages (comma-separated): 'rai_core,rai-perception'."
        required: true
        type: string
      publish_target:
        description: "Publish target"
        required: true
        type: choice
        options:
          - test-pypi
          - pypi

jobs:
  discover-packages:
    name: Discover packages and validate
    runs-on: ubuntu-latest
    outputs:
      packages_json: ${{ steps.discover.outputs.packages_json }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Discover and validate packages
        id: discover
        run: |
          python scripts/discover_packages.py --output-format json > packages.json
          python scripts/validate_packages.py validate packages.json "${{ inputs.package }}" "${{ inputs.publish_target }}" "$GITHUB_OUTPUT"

  build_wheels:
    name: Build wheels
    runs-on: ubuntu-latest
    needs: [discover-packages]
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.discover-packages.outputs.packages_json) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install build tools
        # once we move to python 3.11+, we can upgrade cibuildwheel to 3.3.0
        run: |
          python -m pip install --upgrade pip wheel build
          python -m pip install cibuildwheel==2.21.3 poetry

      - name: Check if package has C extensions
        id: check_extensions
        run: |
          python scripts/validate_packages.py check-c-ext
        env:
          PACKAGE_JSON: ${{ toJson(matrix.package) }}

      - name: Build wheels (pure Python)
        if: steps.check_extensions.outputs.has_c_extensions == 'false'
        working-directory: ${{ matrix.package.path }}
        run: |
          # Build universal wheels (py3-none-any.whl) for pure Python packages
          # This ensures PyPI accepts the wheels without platform tag issues
          python -m build --wheel
          mkdir -p wheelhouse
          cp dist/*.whl wheelhouse/

      - name: Build wheels (with C extensions)
        if: steps.check_extensions.outputs.has_c_extensions == 'true'
        working-directory: ${{ matrix.package.path }}
        env:
          CIBW_BUILD: cp310-* cp312-*
          # Alpine Linux (musllinux) is not supported due to Rust compilation issues on musl-based systems
          CIBW_SKIP: pp* *-win32 *-manylinux_i686 *-musllinux*
          CIBW_BEFORE_BUILD: |
            set -e
            # Upgrade pip first to ensure it can find pre-built wheels
            python -m pip install --upgrade pip wheel setuptools
            # Install Rust compiler for packages like tiktoken that need to build from source
            if ! command -v rustc &> /dev/null; then
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
              export PATH="$HOME/.cargo/bin:$PATH"
            fi
            # Install Poetry (already installed in main step, but needed in container)
            python -m pip install poetry
            # Configure pip to prefer binary wheels over source builds
            export PIP_PREFER_BINARY=1
            # Only use Poetry if poetry.lock exists
            if [ -f poetry.lock ]; then
              poetry install --no-interaction --no-root --only main
            fi
          CIBW_BUILD_FRONTEND: build
          CIBW_PROJECT_REQUIRES_PYTHON: ">=3.10,<3.13"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
          # add Rust's bin directory for compiling pkg like tiktoken
          CIBW_ENVIRONMENT: 'PATH="$HOME/.cargo/bin:$PATH"'
        run: |
          python -m cibuildwheel --output-dir wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.package.name }}
          path: ${{ matrix.package.path }}/wheelhouse/*.whl
          retention-days: 7

  build_sdist:
    name: Build source distributions
    runs-on: ubuntu-latest
    needs: [discover-packages]
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.discover-packages.outputs.packages_json) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.1.1

      - name: Build source distribution
        working-directory: ${{ matrix.package.path }}
        run: |
          poetry build --format sdist

      - name: Upload source distribution
        uses: actions/upload-artifact@v4
        with:
          name: sdist-${{ matrix.package.name }}
          path: ${{ matrix.package.path }}/dist/*.tar.gz
          retention-days: 7

  publish_test_pypi:
    name: Publish to Test PyPI
    if: inputs.publish_target == 'test-pypi'
    runs-on: ubuntu-latest
    needs: [discover-packages, build_wheels, build_sdist]
    environment: test-pypi
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: wheels-*
          merge-multiple: true
          path: artifacts/wheels

      - name: Download sdist artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: sdist-*
          merge-multiple: true
          path: artifacts/sdist

      - name: Organize artifacts
        uses: ./.github/actions/organize-artifacts

      - name: Publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          repository-url: https://test.pypi.org/legacy/

      - name: Verify installation from Test PyPI
        run: |
          PACKAGES_JSON='${{ needs.discover-packages.outputs.packages_json }}'
          PACKAGE_NAMES=$(python scripts/validate_packages.py extract-names "$PACKAGES_JSON")
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ $PACKAGE_NAMES
          echo "Packages published to Test PyPI: $PACKAGE_NAMES"

  publish_pypi:
    name: Publish to PyPI
    if: inputs.publish_target == 'pypi'
    runs-on: ubuntu-latest
    needs: [discover-packages, build_wheels, build_sdist]
    environment: pypi
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: wheels-*
          merge-multiple: true
          path: artifacts/wheels

      - name: Download sdist artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: sdist-*
          merge-multiple: true
          path: artifacts/sdist

      - name: Organize artifacts
        uses: ./.github/actions/organize-artifacts

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

      - name: Verify installation from PyPI
        run: |
          PACKAGES_JSON='${{ needs.discover-packages.outputs.packages_json }}'
          PACKAGE_NAMES=$(python scripts/validate_packages.py extract-names "$PACKAGES_JSON")
          pip install $PACKAGE_NAMES
          echo "Packages published to PyPI: $PACKAGE_NAMES"
